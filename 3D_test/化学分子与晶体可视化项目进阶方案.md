# 化学分子与晶体可视化项目进阶方案

这是一个非常棒的进阶想法！你目前的代码（api.py 和 index.html）已经打通了“数据到渲染”的链路，但要实现从“分子”跨越到“晶体”，并支持“中文名输入”，我们需要对架构进行逻辑升级。

---

## 核心瓶颈分析

1.  **输入端**：RDKit 本身不支持中文识别，也不支持根据名称（如“氯化钠”）直接查找。

2.  **数据端**：RDKit 擅长处理孤立分子，但不擅长处理无限延伸的晶体点阵（如离子晶体、金属晶体）。

3.  **渲染端**：3Dmol.js 支持晶胞渲染，但需要你提供晶格参数 (a, b, c, α, β, γ) 或 CIF 文件。

---

## 实现规划

### 第一步：中文名称/化学式到标识符的映射 (Mapping Layer)

既然不想用付费 API（如 GPT-4），我们可以利用公开免费的化学数据库 API 或本地预设库。

- **方案建议**：

- **PubChem PUG REST API (免费)**：它是全球最大的化学数据库，支持 Name -> SMILES 的转换。

- **本地知识库 (JSON)**：高中化学涉及的晶体其实很有限（约 20-30 种，如 NaCl、CsCl、金刚石等），可以预先建立一个中文名称到化学式或 CIF 文件的映射表。

### 第二步：引入晶体数据支持 (Crystal Data)

对于离子晶体（NaCl）或共价晶体（金刚石），不能只传原子坐标，必须传 CIF (Crystallographic Information File) 格式。

- **方案建议**：

- 使用 Python 库 `pymatgen`（开源、免费、专业）。它能帮你生成晶胞模型。

- **数据流**：用户输入“氯化钠” -> 匹配到 CIF 文件 -> 后端计算出晶胞内的所有原子坐标 -> 传给前端。

### 第三步：后端逻辑重构 (api.py)

你需要修改 /parse 接口，增加一个“类型判断”逻辑：

|输入类型|判定逻辑|返回内容|
|---|---|---|
|分子 (如乙醇)|SMILES 存在|返回 PDB 字符串 + isCrystal: false|
|晶体 (如 NaCl)|命中本地晶体库|返回 CIF/JSON 数据 + isCrystal: true|
### 第四步：前端交互升级 (index.html)

- **切换按钮**：当识别到分子（如 CO₂）时，提供“分子”和“晶体（干冰）”两个切换标签。

- **晶胞渲染**：调用 viewer.addUnitCell() 和 viewer.replicateUnitCell(2, 2, 2)。

---

## 具体的实现建议代码块

### 1. 后端：增加本地化化学数据库映射

在 api.py 中添加一个简单的映射逻辑：

```python
# 模拟本地晶体数据库
CRYSTAL_DB = {
    "氯化钠": {"type": "ionic", "formula": "NaCl", "cif_file": "nacl.cif"},
    "金刚石": {"type": "covalent", "formula": "C", "cif_file": "diamond.cif"},
    "干冰": {"type": "molecular_crystal", "formula": "CO2", "smiles": "O=C=O", "cif_file": "co2.cif"}
}

@app.post("/search")
def search_chemical(name: str):
    # 1. 检查是否在本地晶体库
    if name in CRYSTAL_DB:
        return {"type": "crystal", "data": CRYSTAL_DB[name]}
    
    # 2. 如果不在，尝试调用 PubChem API 获取 SMILES（免费）
    # 示例：https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/water/property/CanonicalSMILES/JSON
    # ... 编写请求代码 ...
```

### 2. 前端：3Dmol.js 的晶胞渲染封装

在 index.html 中，当收到晶体数据时，使用以下配置：

```javascript
function renderCrystal(cifData) {
    viewer.clear();
    viewer.addModel(cifData, "cif");

    // 设置样式
    viewer.setStyle({}, { sphere: { scale: 0.3 } });

    // 核心：添加晶胞边框
    viewer.addUnitCell();

    // 核心：阵列复制，展示 2x2x2 的晶阵
    viewer.replicateUnitCell(2, 2, 2);

    viewer.zoomTo();
    viewer.render();
}
```

---

## 下一步建议

1.  **收集 CIF 文件**：你可以去 [COD (Crystallography Open Database)](https://www.crystallography.net/cod/) 免费下载高中常见的晶体文件。

2.  **增强搜索逻辑**：我们可以先写一个简单的 Python 脚本，通过 requests 访问 PubChem，把“中文名 -> 英文名 -> SMILES”这条路跑通。

---

要不要我帮你把这个文档再细化成一个可直接执行的项目 checklist，方便你一步步落地？
> （注：文档部分内容可能由 AI 生成）