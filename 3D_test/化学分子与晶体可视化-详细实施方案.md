# 化学分子与晶体可视化项目 - 实施清单

> 版本：v2.0
> 创建日期：2025-02-13
> 状态：待实施

---

## 准备阶段

### 账号注册

- [ ] 注册 [Materials Project](https://next-gen.materialsproject.org/) 账号（免费）
- [ ] 获取 API Key
- [ ] 测试 API Key 是否可用
- [ ] 创建 `.env` 文件，存储 API Key

### 资料收集

- [ ] 测试 PubChem API 可用性
  - [ ] 测试：`https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/benzene/property/CanonicalSMILES/JSON`
- [ ] 下载常见晶体 CIF 文件（20个）
  - [ ] NaCl (氯化钠) - COD: 9008816
  - [ ] CsCl (氯化铯) - COD: 9008964
  - [ ] CaF₂ (萤石) - COD: 9001290
  - [ ] MgO (氧化镁) - COD: 9000126
  - [ ] ZnS (闪锌矿) - COD: 9008825
  - [ ] ZnS (纤锌矿) - COD: 9008492
  - [ ] C (金刚石) - COD: 9008567
  - [ ] C (石墨) - COD: 9008570
  - [ ] Si (晶体硅) - COD: 9008828
  - [ ] SiO₂ (石英) - COD: 9000841
  - [ ] Cu (铜) - COD: 9008832
  - [ ] Fe (铁) - COD: 9008469
  - [ ] Mg (镁) - COD: 9008496
  - [ ] Al (铝) - COD: 9008842
  - [ ] Au (金) - COD: 9008841
  - [ ] CO₂ (干冰) - COD: 9008159
  - [ ] H₂O (冰) - COD: 9008843
  - [ ] C₆H₆ (固态苯) - COD: 2300866
  - [ ] C₁₀H₈ (固态萘) - COD: 2100573
  - [ ] I₂ (固态碘) - COD: 2303641

---

## Phase 1: 项目结构搭建

### 创建目录

- [ ] 创建 `data/` 目录
- [ ] 创建 `data/crystals/` 目录
- [ ] 创建 `data/crystals/ionic/` 子目录
- [ ] 创建 `data/crystals/covalent/` 子目录
- [ ] 创建 `data/crystals/metallic/` 子目录
- [ ] 创建 `data/crystals/molecular/` 子目录
- [ ] 创建 `utils/` 目录
- [ ] 创建 `utils/__init__.py` 文件

### 安装依赖

- [ ] 更新 `requirements.txt`，添加：
  ```
  pubchempy>=1.0.0
  requests>=2.31.0
  ase>=3.22.0
  pymatgen>=2023.0.0
  python-dotenv>=1.0.0
  ```
- [ ] 运行 `pip install -r requirements.txt`
- [ ] 验证所有包安装成功

### 配置文件

- [ ] 创建 `config.py`
- [ ] 添加 API 端点配置
- [ ] 添加数据路径配置
- [ ] 添加 Materials Project API Key 读取逻辑

---

## Phase 2: 本地数据层

### 创建名称映射表

- [ ] 创建 `data/name_mapping.json`

- [ ] 添加离子晶体映射
  - [ ] 氯化钠 (NaCl)
  - [ ] 氯化铯 (CsCl)
  - [ ] 萤石 (CaF₂)
  - [ ] 氧化镁 (MgO)
  - [ ] 氧化锌 (ZnS)

- [ ] 添加共价晶体映射
  - [ ] 金刚石 (C)
  - [ ] 石墨 (C)
  - [ ] 晶体硅 (Si)
  - [ ] 二氧化硅 (SiO₂)

- [ ] 添加金属晶体映射
  - [ ] 铜 (Cu)
  - [ ] 铁 (Fe)
  - [ ] 镁 (Mg)
  - [ ] 铝 (Al)
  - [ ] 金 (Au)

- [ ] 添加分子晶体映射
  - [ ] 干冰 (CO₂)
  - [ ] 冰 (H₂O)
  - [ ] 固态苯 (C₆H₆)
  - [ ] 固态碘 (I₂)

- [ ] 添加常见分子映射
  - [ ] 乙醇 (C₂H₅OH)
  - [ ] 苯 (C₆H₆)
  - [ ] 乙酸 (CH₃COOH)
  - [ ] 异辛烷 (C₈H₁₈)
  - [ ] 环己烷 (C₆H₁₂)
  - [ ] 苯丙醇 (C₉H₁₂O)

### 存放 CIF 文件

- [ ] 将下载的 CIF 文件放入对应子目录
- [ ] 验证所有 CIF 文件可读取

---

## Phase 3: 工具模块开发

### PubChem 客户端 (`utils/pubchem_client.py`)

- [ ] 创建文件 `utils/pubchem_client.py`
- [ ] 实现 `get_smiles_by_name(name)` 函数
- [ ] 实现 `get_smiles_by_formula(formula)` 函数
- [ ] 实现 `get_compound_info(cid)` 函数
- [ ] 实现 `search_by_name(name)` 函数（模糊搜索）
- [ ] 添加错误处理和重试逻辑
- [ ] 添加缓存功能

### 晶体数据库客户端 (`utils/crystal_client.py`)

- [ ] 创建文件 `utils/crystal_client.py`
- [ ] 实现 `get_from_materials_project(formula, api_key)` 函数
- [ ] 实现 `get_from_cod(cod_id)` 函数
- [ ] 实现 `get_local_cif(crystal_name)` 函数
- [ ] 实现 `parse_cif_file(cif_content)` 函数
- [ ] 添加晶格参数提取逻辑
- [ ] 添加错误处理

### 名称解析器 (`utils/name_resolver.py`)

- [ ] 创建文件 `utils/name_resolver.py`
- [ ] 实现 `resolve_query(query)` 函数
- [ ] 实现 `is_in_local_db(query)` 函数
- [ ] 实现 `get_crystal_type(query)` 函数
- [ ] 实现 `determine_molecule_or_crystal(query)` 函数

---

## Phase 4: 后端 API 开发

### 新增数据模型 (`api.py`)

- [ ] 添加 `SearchRequest` 模型
  ```python
  class SearchRequest(BaseModel):
      query: str
  ```

- [ ] 添加 `MoleculeResponse` 模型
- [ ] 添加 `CrystalResponse` 模型
- [ ] 添加 `SearchResponse` 模型

### 实现 `/search` 端点

- [ ] 添加路由装饰器 `@app.post("/search")`
- [ ] 实现本地数据库查找逻辑
- [ ] 实现 PubChem 搜索逻辑
- [ ] 合并结果并返回
- [ ] 添加错误处理

### 实现 `/molecule` 端点

- [ ] 添加路由装饰器 `@app.post("/molecule")`
- [ ] 实现名称/化学式 → SMILES 转换
- [ ] 调用 RDKit 生成 3D 结构
- [ ] 获取分子信息
- [ ] 返回 PDB/SDF 和分子信息

### 实现 `/crystal` 端点

- [ ] 添加路由装饰器 `@app.post("/crystal")`
- [ ] 实现本地 CIF 查找
- [ ] 实现 Materials Project 查询
- [ ] 实现 COD 下载
- [ ] 解析 CIF 提取晶格参数
- [ ] 返回 CIF 内容和晶胞信息

### 实现 `/structure` 智能端点

- [ ] 添加路由装饰器 `@app.post("/structure")`
- [ ] 实现类型判断逻辑
  - [ ] 先查本地数据库判断类型
  - [ ] 分子 → 调用 `/molecule` 逻辑
  - [ ] 晶体 → 调用 `/crystal` 逻辑
- [ ] 返回统一格式响应

---

## Phase 5: 前端界面改造

### 输入模块改造

- [ ] 修改输入框 placeholder 支持中文提示
- [ ] 修改输入框清除按钮（已有，保持）
- [ ] 添加搜索建议下拉框（可选）
- [ ] 修改"生成分子"按钮文字为"搜索"

### 视图类型切换 UI

- [ ] 添加"视图类型"分组
- [ ] 添加"分子结构"按钮
- [ ] 添加"晶体结构"按钮
- [ ] 实现按钮状态切换逻辑
- [ ] 添加禁用状态（当只有一种类型时）

### 晶胞控制 UI

- [ ] 添加"晶胞大小"分组
- [ ] 添加 1x1x1 / 2x2x2 / 3x3x3 选择按钮
- [ ] 添加"显示晶胞边框"开关
- [ ] 实现晶胞复制逻辑

### JavaScript 函数

- [ ] 实现 `parseSMILES(smiles)` 函数（已有，保持）
- [ ] 实现 `parseCIF(cif)` 新函数
- [ ] 实现 `renderMolecule(data)` 函数
- [ ] 实现 `renderCrystal(data)` 新函数
- [ ] 实现 `applyCrystalStyle()` 新函数
- [ ] 实现 `replicateCell(x, y, z)` 新函数
- [ ] 实现 `toggleUnitCell()` 新函数
- [ ] 实现 `switchViewType(type)` 新函数
- [ ] 实现 `showCrystalControls(show)` 新函数

### API 调用更新

- [ ] 修改 `visualizeMolecule(smiles)` 函数
- [ ] 添加 `searchStructure(query)` 新函数
- [ ] 添加 `getMolecule(query)` 新函数
- [ ] 添加 `getCrystal(query)` 新函数

### 分子信息面板更新

- [ ] 添加"晶胞类型"显示（晶体模式）
- [ ] 添加"空间群"显示（晶体模式）
- [ ] 添加"晶格参数"显示（晶体模式）
- [ ] 保持原有分子信息显示

---

## Phase 6: 测试

### 分子测试

- [ ] 测试 SMILES 输入（已有功能）
- [ ] 测试中文名称输入
  - [ ] 输入"乙醇"
  - [ ] 输入"苯"
  - [ ] 输入"乙酸"
- [ ] 测试化学式输入
  - [ ] 输入"C2H5OH"
  - [ ] 输入"C6H6"
  - [ ] 输入"CH3COOH"

### 晶体测试

- [ ] 测试离子晶体
  - [ ] 输入"氯化钠" → 显示 NaCl 晶胞
  - [ ] 输入"NaCl" → 显示 NaCl 晶胞
  - [ ] 测试晶胞边框显示
  - [ ] 测试 2x2x2 复制

- [ ] 测试共价晶体
  - [ ] 输入"金刚石" → 显示金刚石晶胞
  - [ ] 输入"石墨" → 显示石墨晶胞

- [ ] 测试金属晶体
  - [ ] 输入"铜" → 显示 Cu 晶胞
  - [ ] 输入"铁" → 显示 Fe 晶胞

- [ ] 测试分子晶体
  - [ ] 输入"干冰" → 显示 CO₂ 晶胞
  - [ ] 测试分子/晶体切换

### 边界测试

- [ ] 测试无效输入
  - [ ] 输入不存在的物质
  - [ ] 输入空字符串
  - [ ] 输入特殊字符
- [ ] 测试网络错误
  - [ ] 关闭后端，测试错误提示
- [ ] 测试后端未连接状态

### UI 测试

- [ ] 测试响应式布局
- [ ] 测试所有按钮交互
- [ ] 测试加载动画
- [ ] 测试错误提示显示

---

## Phase 7: 优化与完善

### 性能优化

- [ ] 添加本地缓存（已查询过的物质）
- [ ] 添加请求防抖（输入框）
- [ ] 优化 CIF 解析速度

### 用户体验

- [ ] 添加更多示例分子/晶体
- [ ] 优化加载提示文案
- [ ] 优化错误提示文案
- [ ] 添加操作提示（首次使用）

### 文档

- [ ] 更新 README.md
- [ ] 添加使用说明
- [ ] 添加 API 文档链接

---

## 附录：参考资料

### API 文档

- [PubChem PUG REST](https://pubchem.ncbi.nlm.nih.gov/docs/pug-rest)
- [Materials Project API](https://materialsproject.org/api)
- [3Dmol.js 文档](https://3dmol.org/doc/)

### CIF 下载

- [Crystallography Open Database](https://www.crystallography.net/cod/)
- 下载格式：`https://www.crystallography.net/cod/{id}.cif`

### Python 库

- [PubChemPy](https://pubchempy.readthedocs.io/)
- [ASE](https://wiki.fysik.dtu.dk/ase/)
- [Pymatgen](https://pymatgen.org/)

---

## 进度统计

| 阶段 | 任务数 | 完成数 | 进度 |
|------|--------|--------|------|
| 准备阶段 | 24 | 0 | 0% |
| Phase 1 | 10 | 0 | 0% |
| Phase 2 | 32 | 0 | 0% |
| Phase 3 | 23 | 0 | 0% |
| Phase 4 | 17 | 0 | 0% |
| Phase 5 | 26 | 0 | 0% |
| Phase 6 | 27 | 0 | 0% |
| Phase 7 | 10 | 0 | 0% |
| **总计** | **169** | **0** | **0%** |

---

*文档版本: v2.0*
*最后更新: 2025-02-13*
